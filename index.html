<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClareGame</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --bg-color: #0f0f1a; --chat-bg: #1a1a2d;
            --primary: #4834d4; --danger: #eb4d4b; --text-white: #ffffff;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background:var(--bg-color); color:var(--text-white); overflow:hidden; height:100vh; width:100vw; }
        .hidden { display:none !important; }

        #ban-overlay { position:fixed; inset:0; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; }

        #auth-container { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:var(--bg-color); z-index:100; }
        .auth-box { background:var(--chat-bg); padding:30px; border-radius:15px; width:280px; text-align:center; border:1px solid var(--primary); }
        .auth-box h2 { color:var(--primary); margin:0 0 15px 0; font-size:24px; }
        .auth-box input { display:block; width:100%; box-sizing:border-box; background:#0f0f1a; border:1px solid #333; color:white; border-radius:8px; padding:10px; font-size:12px; outline:none; margin-bottom:10px; }
        .auth-box input:focus { border-color:var(--primary); }
        .auth-box button { width:100%; padding:12px; background:var(--primary); border:none; border-radius:8px; color:white; font-weight:bold; margin-top:10px; cursor:pointer; }
        .auth-box .toggle { cursor:pointer; color:#888; font-size:11px; margin-top:15px; }
        .auth-box .toggle:hover { color:var(--primary); }

        #game-wrapper { width:100%; height:100vh; display:flex; flex-direction:column; }
        #top-bar { padding:6px 12px; background:rgba(26,26,45,0.97); border-bottom:2px solid var(--primary); display:flex; align-items:center; justify-content:space-between; gap:5px; z-index:50; position:relative; flex-shrink:0; }
        .btn-group { display:flex; align-items:center; gap:4px; overflow-x:auto; scrollbar-width:none; flex:1; }
        .btn-group::-webkit-scrollbar { display:none; }
        .icon-btn { background:#2f3542; color:white; border:none; border-radius:4px; padding:4px 8px; font-size:11px; cursor:pointer; height:26px; flex-shrink:0; transition:transform 0.1s; white-space:nowrap; }
        .icon-btn:active { transform:scale(0.9); }
        .exit-btn { background:#444; color:white; border:none; border-radius:4px; padding:4px 10px; font-size:10px; cursor:pointer; height:26px; }
        .pfp-circle { width:28px; height:28px; border-radius:50%; border:1px solid var(--primary); cursor:pointer; object-fit:cover; flex-shrink:0; }
        #username-tag { font-size:11px; color:#a29bfe; font-weight:600; white-space:nowrap; }

        #canvas-wrap { flex:1; position:relative; overflow:hidden; }
        #game-canvas { display:block; width:100%; height:100%; }

        #hud { position:absolute; inset:0; pointer-events:none; }
        #crosshair { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:16px; height:16px; }
        #crosshair::before,#crosshair::after { content:''; position:absolute; background:rgba(255,255,255,0.7); }
        #crosshair::before { width:2px; height:100%; left:50%; transform:translateX(-50%); }
        #crosshair::after  { height:2px; width:100%; top:50%; transform:translateY(-50%); }

        #pickup-prompt { position:absolute; top:56%; left:50%; transform:translateX(-50%); background:rgba(26,26,45,0.85); border:1px solid var(--primary); padding:5px 14px; font-size:12px; color:#a29bfe; display:none; border-radius:6px; }
        #controls-hint { position:absolute; bottom:80px; left:14px; font-size:10px; color:rgba(162,155,254,0.5); line-height:2; }
        #notif { position:absolute; top:12px; left:50%; transform:translateX(-50%); background:rgba(26,26,45,0.92); border:1px solid var(--primary); padding:5px 18px; font-size:12px; color:#a29bfe; border-radius:6px; display:none; white-space:nowrap; z-index:10; }

        #health-bar { position:absolute; top:12px; right:14px; background:rgba(26,26,45,0.9); border:1px solid var(--primary); border-radius:8px; padding:6px 12px; font-size:12px; display:none; min-width:120px; }
        #hp-fill-wrap { width:100px; height:8px; background:#222; border-radius:4px; margin-top:4px; overflow:hidden; }
        #hp-fill { height:100%; background:var(--primary); border-radius:4px; transition:width 0.3s, background 0.3s; width:100%; }

        #pvp-indicator { position:absolute; top:12px; left:50%; transform:translateX(-50%); background:rgba(235,77,75,0.15); border:1px solid #eb4d4b; border-radius:6px; padding:4px 14px; font-size:11px; color:#eb4d4b; display:none; }
        #status-effects { position:absolute; top:50px; right:14px; display:flex; flex-direction:column; gap:4px; font-size:10px; }
        .status-tag { background:rgba(26,26,45,0.9); border:1px solid #555; border-radius:4px; padding:2px 8px; }

        #inventory { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); display:flex; gap:5px; pointer-events:all; }
        .inv-slot { width:48px; height:48px; border:1px solid rgba(72,52,212,0.4); background:rgba(26,26,45,0.85); display:flex; align-items:center; justify-content:center; font-size:22px; border-radius:6px; cursor:pointer; position:relative; flex-direction:column; }
        .inv-slot.active { border-color:var(--primary); box-shadow:0 0 8px rgba(72,52,212,0.5); }
        .inv-slot .slot-label { font-size:7px; color:#666; position:absolute; bottom:2px; }

        #chat-log { position:absolute; bottom:80px; right:14px; width:270px; max-height:180px; display:flex; flex-direction:column; gap:4px; overflow:hidden; pointer-events:none; }
        .chat-line { background:rgba(26,26,45,0.88); border-left:2px solid var(--primary); padding:4px 8px; font-size:11px; border-radius:0 6px 6px 0; word-break:break-word; animation:slideIn 0.15s ease; }
        .chat-line .cname { color:#a29bfe; font-weight:600; margin-right:4px; }
        .chat-line .cname.sys { color:#2ed573; }
        @keyframes slideIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:translateY(0)} }

        #chat-input-wrap { position:absolute; bottom:20px; right:14px; width:270px; display:none; pointer-events:all; z-index:10; }
        #chat-input-wrap input { width:100%; background:#0f0f1a; border:1px solid var(--primary); color:white; border-radius:8px; padding:8px 12px; font-size:12px; outline:none; font-family:inherit; }
        #chat-input-wrap .chint { font-size:9px; color:#555; margin-top:3px; text-align:right; }

        .overhead-name { position:fixed; pointer-events:none; background:rgba(26,26,45,0.9); border:1px solid var(--primary); color:#a29bfe; font-size:10px; font-weight:600; padding:2px 7px; border-radius:4px; transform:translateX(-50%); white-space:nowrap; font-family:'Inter',sans-serif; }
        .overhead-bubble { position:fixed; pointer-events:none; background:rgba(26,26,45,0.92); border:1px solid var(--primary); color:white; font-size:11px; padding:4px 9px; border-radius:8px; transform:translateX(-50%); max-width:180px; word-break:break-word; text-align:center; font-family:'Inter',sans-serif; }
        .overhead-hp { position:fixed; pointer-events:none; transform:translateX(-50%); }
        .overhead-hp-bar { width:50px; height:4px; background:#333; border-radius:2px; overflow:hidden; }
        .overhead-hp-fill { height:100%; background:#2ed573; border-radius:2px; transition:width 0.3s; }

        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal-box { background:var(--chat-bg); padding:25px; border-radius:15px; width:280px; text-align:center; border:1px solid var(--primary); box-shadow:0 0 20px rgba(72,52,212,0.3); max-height:80vh; overflow-y:auto; }
        .modal-box h3 { margin-bottom:12px; color:var(--primary); }

        @keyframes glow { 0%,100%{box-shadow:0 0 10px gold,0 0 30px gold} 50%{box-shadow:0 0 20px gold,0 0 60px gold} }
        .golden { animation:glow 1s infinite; }
    </style>
</head>
<body>

<div id="ban-overlay" class="hidden">
    <h1 style="color:var(--danger);font-size:40px;">BANNED</h1>
    <p>Your access to ClareGame has been revoked.</p>
</div>

<div id="auth-container">
    <div class="auth-box">
        <h2 id="auth-header">ClareGame</h2>
        <input type="text" id="username-in" placeholder="Username">
        <input type="password" id="password-in" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
        <p class="toggle" id="toggle-auth-text" onclick="toggleMode()">New here? Sign Up</p>
    </div>
</div>

<div id="game-wrapper" class="hidden">
    <div id="top-bar">
        <div class="btn-group">
            <img id="my-mini-pfp" class="pfp-circle" src="https://via.placeholder.com/28">
            <span id="username-tag"></span>
            <button class="icon-btn" onclick="openControls()">â“</button>
            <button class="icon-btn" onclick="openMembers()">ğŸ‘¥</button>
            <button id="pvp-btn" class="icon-btn" onclick="togglePVP()" style="background:#2f3542;">âš”ï¸ PVP: OFF</button>
            <button id="reset-btn" class="icon-btn hidden" onclick="resetAllItems()" style="background:#eb4d4b;">ğŸ”„ Reset Items</button>
        </div>
        <button class="exit-btn" onclick="location.reload()">Exit</button>
    </div>

    <div id="canvas-wrap">
        <canvas id="game-canvas"></canvas>
        <div id="hud">
            <div id="crosshair"></div>
            <div id="pickup-prompt"></div>
            <div id="notif"></div>
            <div id="pvp-indicator">âš”ï¸ PVP MODE â€” F to attack Â· flail swings on flick</div>
            <div id="health-bar">
                â¤ï¸ <span id="hp-val">100</span>/100
                <div id="hp-fill-wrap"><div id="hp-fill"></div></div>
            </div>
            <div id="status-effects"></div>
            <div id="controls-hint">
                WASD Â· move<br>
                MOUSE Â· look (click to lock)<br>
                E Â· pick up<br>
                Q Â· drop selected<br>
                F Â· attack / 3rd person toggle (no weapon)<br>
                1-5 Â· select slot<br>
                / Â· chat
            </div>
            <div id="inventory">
                <div class="inv-slot active" id="slot-0" onclick="selectSlot(0)"><span class="slot-label">1</span></div>
                <div class="inv-slot" id="slot-1" onclick="selectSlot(1)"><span class="slot-label">2</span></div>
                <div class="inv-slot" id="slot-2" onclick="selectSlot(2)"><span class="slot-label">3</span></div>
                <div class="inv-slot" id="slot-3" onclick="selectSlot(3)"><span class="slot-label">4</span></div>
                <div class="inv-slot" id="slot-4" onclick="selectSlot(4)"><span class="slot-label">5</span></div>
            </div>
        </div>
        <div id="chat-log"></div>
        <div id="chat-input-wrap">
            <input type="text" id="chat-in" placeholder="Say something..." maxlength="120">
            <div class="chint">ENTER to send Â· ESC to cancel</div>
        </div>
    </div>
</div>

<div id="master-modal" class="modal-overlay hidden">
    <div class="modal-box" id="modal-content"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fbConfig = {
    apiKey:"AIzaSyB9Rlvq49-AiLBzMDvjz71QCTT4d6NqE98",
    authDomain:"mychat-28205.firebaseapp.com",
    databaseURL:"https://mychat-28205-default-rtdb.firebaseio.com",
    projectId:"mychat-28205",
    storageBucket:"mychat-28205.firebasestorage.app",
    messagingSenderId:"522121848657",
    appId:"1:522121848657:web:7108993439310bf6da5570"
};
firebase.initializeApp(fbConfig);
const db = firebase.database();
const admins = ["44","bboy2014","bartelsfamily5","hunter"];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;
let isLoginMode = true;

function toggleMode() {
    isLoginMode = !isLoginMode;
    document.getElementById('auth-header').innerText      = isLoginMode ? "ClareGame" : "Sign Up";
    document.getElementById('toggle-auth-text').innerText = isLoginMode ? "New here? Sign Up" : "Already have an account? Login";
}
async function handleLogin() {
    const u = document.getElementById('username-in').value.trim().toLowerCase();
    const p = document.getElementById('password-in').value.trim();
    if (!u || !p) return;
    const snap = await db.ref("users/"+u).once("value");
    if (isLoginMode) {
        if (snap.exists() && snap.val().password === p) {
            if (snap.val().banned) return showBanScreen();
            launch(u);
        } else alert("Invalid login.");
    } else {
        if (snap.exists()) return alert("Username taken.");
        await db.ref("users/"+u).set({password:p,pfp:"",status:"Playing",warned:false,banned:false});
        launch(u);
    }
}
document.getElementById('password-in').addEventListener('keydown',e=>{ if(e.key==='Enter') handleLogin(); });
function showBanScreen() {
    document.getElementById('auth-container').classList.add('hidden');
    document.getElementById('game-wrapper').classList.add('hidden');
    document.getElementById('ban-overlay').classList.remove('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ITEM / WEAPON DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// type: 'weapon' or 'item'
// For weapons: damage, cooldown (ms), range, special
// Textures are drawn procedurally on a canvas â†’ THREE texture
const ITEM_DEFS = {
    sword:     { type:'weapon', emoji:'âš”ï¸',  color:0xaaaacc, damage:30, cooldown:2000, range:3.5,  special:'slash',   speed:1,    desc:'Standard slash, 2s cooldown' },
    dagger:    { type:'weapon', emoji:'ğŸ—¡ï¸',  color:0xddddff, damage:15, cooldown:1000, range:2.5,  special:'poke',    speed:1,    desc:'Fast poke, 1s cooldown' },
    katana:    { type:'weapon', emoji:'ğŸŒ€',  color:0xff88aa, damage:20, cooldown:1500, range:3.5,  special:'slash',   speed:1.4,  desc:'Faster movement, 1.5s cooldown' },
    spear:     { type:'weapon', emoji:'ğŸ”±',  color:0xffaa44, damage:10, cooldown:2000, range:6.0,  special:'bleed',   speed:1,    desc:'Long range + 10 bleed over 5s' },
    flail:     { type:'weapon', emoji:'âš™ï¸',  color:0x886644, damage:40, cooldown:0,    range:4.0,  special:'flail',   speed:0.9,  desc:'Swings! Hit by flicking camera' },
    bow:       { type:'weapon', emoji:'ğŸ¹',  color:0x886633, damage:20, cooldown:3000, range:999,  special:'projectile', projSpeed:12, speed:1, desc:'Slow projectile, 3s cooldown' },
    crossbow:  { type:'weapon', emoji:'â•',  color:0x664422, damage:25, cooldown:5000, range:999,  special:'projectile', projSpeed:18, speed:1, desc:'Faster projectile, 5s cooldown' },
    balloon:   { type:'item',   emoji:'ğŸˆ',  color:0xff66aa, special:'speed',   value:0,   desc:'Hold for +speed' },
    apple:     { type:'item',   emoji:'ğŸ',  color:0xff2222, special:'heal',    value:20,  desc:'Heals 20 HP' },
    banana:    { type:'item',   emoji:'ğŸŒ',  color:0xffdd00, special:'heal',    value:15,  desc:'Heals 15 HP' },
    chocolate: { type:'item',   emoji:'ğŸ«',  color:0x663311, special:'speed_burst', value:10, desc:'Speed boost 10s' },
    bear_trap: { type:'item',   emoji:'ğŸª¤',  color:0x885533, special:'trap',    value:15,  trapSlow:0.4, trapTime:5000, trapRadius:1.5, trapDuration:60000, desc:'Slows+hurts enemies' },
    web_trap:  { type:'item',   emoji:'ğŸ•¸ï¸',  color:0xdddddd, special:'web',     value:0,   trapSlow:0.2, trapTime:99999, trapRadius:2.0, trapDuration:30000, desc:'Slows enemies while on it' },
    poison_apple:{ type:'item', emoji:'ğŸ',  color:0x33dd44, special:'poison',  value:10,  desc:'Poisons for 10 dmg' },
    golden_apple:{ type:'item', emoji:'âœ¨',  color:0xffdd00, special:'golden',  value:100, desc:'Full heal + 5s immunity!' },
};

// Spawn positions for world items (id, defKey, x, z)
const SPAWN_TABLE = [
    {id:'w1',def:'sword',    x:8,   z:5  },
    {id:'w2',def:'dagger',   x:-6,  z:3  },
    {id:'w3',def:'katana',   x:12,  z:-10},
    {id:'w4',def:'spear',    x:-3,  z:12 },
    {id:'w5',def:'flail',    x:0,   z:-8 },
    {id:'w6',def:'bow',      x:15,  z:2  },
    {id:'w7',def:'crossbow', x:-12, z:-6 },
    {id:'c1',def:'balloon',  x:4,   z:15 },
    {id:'c2',def:'apple',    x:-8,  z:-8 },
    {id:'c3',def:'banana',   x:10,  z:10 },
    {id:'c4',def:'chocolate',x:-10, z:6  },
    {id:'c5',def:'bear_trap',x:6,   z:-6 },
    {id:'c6',def:'web_trap', x:-4,  z:-14},
    {id:'c7',def:'poison_apple',x:14,z:-4},
    {id:'g1',def:'golden_apple',x:0,z:0  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let scene, camera, renderer, clock;
let thirdPerson = false;
let selfMesh = null;
let otherPlayers  = {}; // u â†’ {mesh,nameEl,hpEl,hpFill,hp}
let worldItemMeshes = {}; // id â†’ mesh
let pickedUpItems = {};   // id â†’ true
let inventory     = [null,null,null,null,null];
let chatting      = false;
let selectedSlot  = 0;
let yaw=0, pitch=0, prevYaw=0;
let pvpMode = false;
let myHP = 100;
const MAX_HP = 100;
const PLAYER_SPEED = 6;
const PLAYER_HEIGHT = 1.0;
const PICKUP_DIST = 2.8;
const MAX_FLOOR_WEAPONS = 20;
const MAX_FLOOR_ITEMS   = 20;
const keys = {};
const bubbles = {};
const projectiles = []; // {mesh, vel, owner, dmg, weapon, born}
const trapMeshes  = {}; // id â†’ {mesh, def, owner, born, x, z}
const statusEffects = {}; // effect â†’ timer
let lastAttackTime = 0;
let flailAngle = 0;
let flailMesh = null;
let goldenImmune = false;
let bleedInterval = null;
let speedMult = 1;
const _v3 = new THREE.Vector3();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEXTURE BUILDER  (procedural canvas textures)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeTexture(drawFn, size=64) {
    const c = document.createElement('canvas');
    c.width = c.height = size;
    const ctx = c.getContext('2d');
    drawFn(ctx, size);
    const tex = new THREE.CanvasTexture(c);
    return tex;
}

const TEX = {};
function buildTextures() {
    // Sword â€” silver blade
    TEX.sword = makeTexture((ctx,s)=>{
        ctx.fillStyle='#1a1a2d'; ctx.fillRect(0,0,s,s);
        const g=ctx.createLinearGradient(s/2-4,0,s/2+4,s);
        g.addColorStop(0,'#ccccee'); g.addColorStop(0.5,'#ffffff'); g.addColorStop(1,'#8888aa');
        ctx.fillStyle=g; ctx.fillRect(s/2-3,4,6,s-20);
        ctx.fillStyle='#aaaacc'; ctx.fillRect(s/2-10,s-18,20,5); // guard
        ctx.fillStyle='#665544'; ctx.fillRect(s/2-2,s-13,4,10); // handle
    });
    // Dagger
    TEX.dagger = makeTexture((ctx,s)=>{
        ctx.fillStyle='#0f0f1a'; ctx.fillRect(0,0,s,s);
        const g=ctx.createLinearGradient(s/2-2,0,s/2+2,s);
        g.addColorStop(0,'#eeeeff'); g.addColorStop(1,'#9999bb');
        ctx.fillStyle=g; ctx.fillRect(s/2-2,8,4,s-28);
        ctx.fillStyle='#7777aa'; ctx.fillRect(s/2-8,s-22,16,4);
        ctx.fillStyle='#554433'; ctx.fillRect(s/2-2,s-18,4,8);
    });
    // Katana â€” pink/red
    TEX.katana = makeTexture((ctx,s)=>{
        ctx.fillStyle='#110010'; ctx.fillRect(0,0,s,s);
        const g=ctx.createLinearGradient(s/2-2,0,s/2+4,s);
        g.addColorStop(0,'#ffaacc'); g.addColorStop(0.5,'#ffffff'); g.addColorStop(1,'#dd4488');
        ctx.fillStyle=g;
        ctx.save(); ctx.translate(s/2,s/2); ctx.rotate(0.1);
        ctx.fillRect(-2,-s/2+4,4,s-16); ctx.restore();
        ctx.fillStyle='#cc2266'; ctx.fillRect(s/2-6,s-16,12,3);
        ctx.fillStyle='#221122'; ctx.fillRect(s/2-2,s-13,4,9);
    });
    // Spear â€” orange tip
    TEX.spear = makeTexture((ctx,s)=>{
        ctx.fillStyle='#0f0f1a'; ctx.fillRect(0,0,s,s);
        ctx.fillStyle='#664400'; ctx.fillRect(s/2-2,16,4,s-16);
        const g=ctx.createLinearGradient(s/2-3,0,s/2+3,16);
        g.addColorStop(0,'#ffcc44'); g.addColorStop(1,'#ff8800');
        ctx.fillStyle=g;
        ctx.beginPath(); ctx.moveTo(s/2,2); ctx.lineTo(s/2-5,16); ctx.lineTo(s/2+5,16); ctx.fill();
    });
    // Flail â€” dark iron ball
    TEX.flail = makeTexture((ctx,s)=>{
        ctx.fillStyle='#1a1a2d'; ctx.fillRect(0,0,s,s);
        ctx.fillStyle='#442200'; ctx.fillRect(s/2-1,4,2,s/2-8);
        const g=ctx.createRadialGradient(s/2,s/2+8,2,s/2,s/2+8,14);
        g.addColorStop(0,'#aaaaaa'); g.addColorStop(1,'#333333');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s/2,s/2+10,12,0,Math.PI*2); ctx.fill();
        // spikes
        for(let i=0;i<6;i++){
            const a=i*Math.PI/3;
            ctx.fillStyle='#888888';
            ctx.save(); ctx.translate(s/2+Math.cos(a)*10,s/2+10+Math.sin(a)*10);
            ctx.rotate(a); ctx.fillRect(-1,-4,2,4); ctx.restore();
        }
    });
    // Bow
    TEX.bow = makeTexture((ctx,s)=>{
        ctx.fillStyle='#0f0f1a'; ctx.fillRect(0,0,s,s);
        ctx.strokeStyle='#886633'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.arc(s/2,s/2,24,Math.PI*0.1,Math.PI*0.9,false); ctx.stroke();
        ctx.strokeStyle='#ddddaa'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(s/2,s/2-24); ctx.lineTo(s/2,s/2+24); ctx.stroke();
    });
    // Crossbow
    TEX.crossbow = makeTexture((ctx,s)=>{
        ctx.fillStyle='#0f0f1a'; ctx.fillRect(0,0,s,s);
        ctx.fillStyle='#553311'; ctx.fillRect(s/2-2,8,4,s-16);
        ctx.strokeStyle='#886633'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.moveTo(8,s/2); ctx.lineTo(s-8,s/2); ctx.stroke();
        ctx.strokeStyle='#ccbbaa'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(8,s/2); ctx.lineTo(s/2,s/2-8); ctx.lineTo(s-8,s/2); ctx.stroke();
    });
    // Balloon
    TEX.balloon = makeTexture((ctx,s)=>{
        const g=ctx.createRadialGradient(s/2-4,s/2-4,2,s/2,s/2,20);
        g.addColorStop(0,'#ff99cc'); g.addColorStop(1,'#cc0066');
        ctx.fillStyle=g; ctx.beginPath(); ctx.ellipse(s/2,s/2-4,14,18,0,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle='#ffddee'; ctx.lineWidth=1; ctx.stroke();
        ctx.strokeStyle='#cc99bb'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(s/2,s/2+14); ctx.lineTo(s/2+4,s/2+24); ctx.stroke();
    });
    // Apple (red)
    TEX.apple = makeTexture((ctx,s)=>{
        const g=ctx.createRadialGradient(s/2-4,s/2-4,2,s/2,s/2,18);
        g.addColorStop(0,'#ff6666'); g.addColorStop(1,'#cc0000');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s/2,s/2+2,16,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#44aa22'; ctx.fillRect(s/2-1,6,2,8);
    });
    // Banana
    TEX.banana = makeTexture((ctx,s)=>{
        ctx.fillStyle='#ffee00';
        ctx.beginPath(); ctx.ellipse(s/2,s/2,8,22,0.4,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#ccbb00';
        ctx.beginPath(); ctx.ellipse(s/2,s/2,6,20,0.4,0,Math.PI*2); ctx.strokeStyle='#aaaa00'; ctx.lineWidth=1; ctx.stroke();
    });
    // Chocolate
    TEX.chocolate = makeTexture((ctx,s)=>{
        ctx.fillStyle='#442211'; ctx.fillRect(6,14,s-12,s-28);
        ctx.strokeStyle='#331100'; ctx.lineWidth=1;
        for(let i=1;i<3;i++){ctx.beginPath();ctx.moveTo(6+i*(s-12)/3,14);ctx.lineTo(6+i*(s-12)/3,s-14);ctx.stroke();}
        ctx.beginPath();ctx.moveTo(6,14+(s-28)/2);ctx.lineTo(s-6,14+(s-28)/2);ctx.stroke();
        ctx.fillStyle='#663322'; ctx.fillRect(7,15,s-14,s-30);
    });
    // Bear trap
    TEX.bear_trap = makeTexture((ctx,s)=>{
        ctx.fillStyle='#885533'; ctx.strokeStyle='#553311'; ctx.lineWidth=2;
        ctx.beginPath(); ctx.arc(s/2,s/2+8,16,Math.PI,0,false); ctx.fill(); ctx.stroke();
        ctx.beginPath(); ctx.arc(s/2,s/2+8,16,0,Math.PI,false); ctx.fill(); ctx.stroke();
        // teeth
        for(let i=0;i<5;i++){
            ctx.fillStyle='#cccccc';
            ctx.fillRect(s/2-14+i*7,s/2+2,3,6);
            ctx.fillRect(s/2-14+i*7,s/2+4,3,-6);
        }
    });
    // Web trap
    TEX.web_trap = makeTexture((ctx,s)=>{
        ctx.strokeStyle='rgba(220,220,220,0.8)'; ctx.lineWidth=1;
        for(let r=4;r<s/2;r+=8){
            ctx.beginPath(); ctx.arc(s/2,s/2,r,0,Math.PI*2); ctx.stroke();
        }
        for(let a=0;a<8;a++){
            const ang=a*Math.PI/4;
            ctx.beginPath(); ctx.moveTo(s/2,s/2);
            ctx.lineTo(s/2+Math.cos(ang)*s/2,s/2+Math.sin(ang)*s/2); ctx.stroke();
        }
    });
    // Poison apple
    TEX.poison_apple = makeTexture((ctx,s)=>{
        const g=ctx.createRadialGradient(s/2-4,s/2-4,2,s/2,s/2,18);
        g.addColorStop(0,'#aaffaa'); g.addColorStop(1,'#228822');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s/2,s/2+2,16,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#008800'; ctx.fillRect(s/2-1,6,2,8);
        ctx.fillStyle='rgba(0,200,0,0.4)'; ctx.beginPath(); ctx.arc(s/2,s/2,12,0,Math.PI*2); ctx.fill();
    });
    // Golden apple
    TEX.golden_apple = makeTexture((ctx,s)=>{
        const g=ctx.createRadialGradient(s/2-4,s/2-4,2,s/2,s/2,18);
        g.addColorStop(0,'#ffffaa'); g.addColorStop(0.5,'#ffdd00'); g.addColorStop(1,'#cc8800');
        ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s/2,s/2+2,16,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle='#ffeeaa'; ctx.lineWidth=1.5; ctx.stroke();
        ctx.fillStyle='#448822'; ctx.fillRect(s/2-1,6,2,8);
        // sparkle
        ctx.fillStyle='#ffffcc';
        [[s/2-8,s/2-8],[s/2+10,s/2-4],[s/2+4,s/2+10]].forEach(([x,y])=>{
            ctx.beginPath(); ctx.arc(x,y,2,0,Math.PI*2); ctx.fill();
        });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LAUNCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launch(u) {
    currentUser = u;
    document.getElementById('auth-container').classList.add('hidden');
    document.getElementById('game-wrapper').classList.remove('hidden');
    document.getElementById('username-tag').innerText = u;
    if (u === 'bartelsfamily5') document.getElementById('reset-btn').classList.remove('hidden');

    db.ref("users/"+u+"/pfp").on("value",s=>{ document.getElementById('my-mini-pfp').src = s.val()||'https://via.placeholder.com/28'; });
    db.ref("users/"+u).on("value",s=>{
        if(!s.exists()) return;
        const d=s.val();
        if(d.banned){showBanScreen();return;}
        if(d.warned===true){alert("âš ï¸ ADMIN WARNING: Please follow the rules.");db.ref("users/"+u).update({warned:false});}
    });

    buildTextures();
    initGame();
    initFirebase();
    initPVP();
    startAutoSpawn();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showModal(html) {
    document.getElementById('modal-content').innerHTML = html +
        `<button onclick="closeModal()" style="background:var(--primary);width:100%;margin-top:15px;border:none;border-radius:6px;color:white;padding:8px;cursor:pointer;">Close</button>`;
    document.getElementById('master-modal').classList.remove('hidden');
}
function closeModal() { document.getElementById('master-modal').classList.add('hidden'); }

function openControls() {
    showModal(`<h3>Controls</h3>
    <div style="text-align:left;font-size:12px;line-height:2;color:#aaa;">
        <b style="color:white;">WASD</b> â€” Move<br>
        <b style="color:white;">Mouse</b> â€” Look (click canvas to lock)<br>
        <b style="color:white;">E</b> â€” Pick up nearby item<br>
        <b style="color:white;">Q</b> â€” Drop selected slot<br>
        <b style="color:white;">F</b> â€” Attack (weapon) / toggle 3rd person (no weapon)<br>
        <b style="color:white;">1â€“5</b> â€” Select inventory slot<br>
        <b style="color:white;">/</b> â€” Open chat<br>
        <hr style="border-color:#333;margin:8px 0">
        <b style="color:#eb4d4b;">Flail</b> â€” No F attack. Flick mouse fast to swing!<br>
        <b style="color:#ffdd00;">Golden Apple</b> â€” Full heal + 5s immunity, only 1 exists<br>
        <b style="color:#aaffaa;">Katana</b> â€” Holder moves faster<br>
        <b style="color:#ffaa44;">Spear</b> â€” Long range + bleed damage<br>
        <b style="color:#ff66aa;">Balloon</b> â€” Hold for speed boost
    </div>`);
}

function openMembers() {
    db.ref("claregame_players").once("value", snap => {
        let html = `<h3>ğŸ‘¥ Online Now</h3>`;
        if (!snap.exists()) html += `<p style="color:#666;font-size:12px;">Nobody else is online.</p>`;
        snap.forEach(c => {
            html += `<div style="text-align:left;padding:6px 0;border-bottom:1px solid #333;font-size:12px;">
                <b style="color:#a29bfe;">${c.key}</b>
                ${admins.includes(c.key)?'<span style="color:var(--primary);font-size:9px;margin-left:4px;">[ADM]</span>':''}
            </div>`;
        });
        showModal(html);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THREE.JS INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGame() {
    const canvas = document.getElementById('game-canvas');
    const wrap   = document.getElementById('canvas-wrap');
    renderer = new THREE.WebGLRenderer({canvas,antialias:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(wrap.clientWidth,wrap.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.setClearColor(0x0f0f1a);
    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x0f0f1a,22,70);
    camera = new THREE.PerspectiveCamera(75,wrap.clientWidth/wrap.clientHeight,0.1,200);
    camera.position.set(0,PLAYER_HEIGHT,0);
    camera.rotation.order='YXZ';
    clock = new THREE.Clock();

    buildWorld();
    spawnAllItems();
    setupInput();
    document.getElementById('health-bar').style.display='block';
    animate();

    window.addEventListener('resize',()=>{
        const w=wrap.clientWidth,h=wrap.clientHeight;
        renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix();
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORLD BUILD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildWorld() {
    // Ground with subtle texture
    const groundTex = makeTexture((ctx,s)=>{
        ctx.fillStyle='#12122a'; ctx.fillRect(0,0,s,s);
        ctx.strokeStyle='#1a1a3a'; ctx.lineWidth=1;
        for(let i=0;i<s;i+=8){
            ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,s);ctx.stroke();
            ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(s,i);ctx.stroke();
        }
    },128);
    groundTex.wrapS=groundTex.wrapT=THREE.RepeatWrapping;
    groundTex.repeat.set(20,20);
    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(120,120),
        new THREE.MeshLambertMaterial({map:groundTex})
    );
    ground.rotation.x=-Math.PI/2; ground.receiveShadow=true; scene.add(ground);

    const grid = new THREE.GridHelper(120,60,0x4834d4,0x1e1e35);
    grid.position.y=0.01; scene.add(grid);

    scene.add(new THREE.AmbientLight(0x4834d4,0.4));
    const dL = new THREE.DirectionalLight(0xffffff,0.6); dL.position.set(10,20,10); scene.add(dL);
    const pL = new THREE.PointLight(0x4834d4,2,40); pL.position.set(0,8,0); scene.add(pL);

    // Obstacle blocks with brick-ish texture
    const brickTex = makeTexture((ctx,s)=>{
        ctx.fillStyle='#1a1a3a'; ctx.fillRect(0,0,s,s);
        ctx.strokeStyle='#4834d4'; ctx.lineWidth=0.5; ctx.globalAlpha=0.4;
        for(let y=0;y<s;y+=8){
            const off=(y/8%2)*12;
            for(let x=-12;x<s;x+=24){
                ctx.strokeRect(x+off,y,22,7);
            }
        }
    },64);

    [[8,1,8],[-8,1,8],[8,1,-8],[-8,1,-8],
     [0,1,15],[15,1,0],[0,1,-15],[-15,1,0],
     [12,2,4],[-12,2,-4],[5,0.5,-12],[-5,0.5,12]
    ].forEach(([x,y,z])=>{
        const h=y*2;
        const geo=new THREE.BoxGeometry(2,h,2);
        const mat=new THREE.MeshLambertMaterial({map:brickTex});
        const mesh=new THREE.Mesh(geo,mat); mesh.position.set(x,h/2,z); mesh.castShadow=true; scene.add(mesh);
        mesh.add(new THREE.LineSegments(new THREE.EdgesGeometry(geo),new THREE.LineBasicMaterial({color:0x4834d4,transparent:true,opacity:0.4})));
    });

    // Self mesh (shown in 3rd person)
    selfMesh = makePlayerMesh(0x4834d4, false);
    selfMesh.visible = false;
    scene.add(selfMesh);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER MESH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makePlayerMesh(hexColor, addEdges=true) {
    const group = new THREE.Group();
    const skinTex = makeTexture((ctx,s)=>{
        ctx.fillStyle='#'+hexColor.toString(16).padStart(6,'0');
        ctx.fillRect(0,0,s,s);
        ctx.globalAlpha=0.3; ctx.fillStyle='#ffffff';
        ctx.fillRect(0,0,s,s/2);
    },32);
    const mat = new THREE.MeshLambertMaterial({color:hexColor});
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.8,1.0,0.8),mat);
    body.position.y=0.5; group.add(body);
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.65,0.65,0.65),mat);
    head.position.y=1.32; group.add(head);
    [-0.15,0.15].forEach(ex=>{
        const eye=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.08,0.05),new THREE.MeshBasicMaterial({color:0x000000}));
        eye.position.set(ex,1.36,-0.33); group.add(eye);
    });
    if(addEdges){
        [new THREE.BoxGeometry(0.8,1.0,0.8),new THREE.BoxGeometry(0.65,0.65,0.65)].forEach((g,i)=>{
            const e=new THREE.LineSegments(new THREE.EdgesGeometry(g),new THREE.LineBasicMaterial({color:hexColor}));
            e.position.y=i===0?0.5:1.32; group.add(e);
        });
    }
    return group;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ITEM MESH BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeItemMesh(defKey) {
    const def = ITEM_DEFS[defKey];
    const tex = TEX[defKey];
    const mat = tex
        ? new THREE.MeshLambertMaterial({map:tex,transparent:true})
        : new THREE.MeshLambertMaterial({color:def.color,emissive:def.color,emissiveIntensity:0.3});

    let geo;
    // Shape based on item type
    if(defKey==='banana')          geo=new THREE.BoxGeometry(0.15,0.5,0.15);
    else if(defKey==='chocolate')  geo=new THREE.BoxGeometry(0.5,0.1,0.3);
    else if(defKey==='spear')      geo=new THREE.BoxGeometry(0.1,0.6,0.1);
    else if(defKey==='flail')      geo=new THREE.SphereGeometry(0.22,8,8);
    else if(defKey==='balloon')    geo=new THREE.SphereGeometry(0.22,10,10);
    else if(defKey==='bear_trap')  geo=new THREE.CylinderGeometry(0.3,0.3,0.08,8);
    else if(defKey==='web_trap')   geo=new THREE.CylinderGeometry(0.35,0.35,0.04,12);
    else                            geo=new THREE.BoxGeometry(0.4,0.4,0.4);

    const mesh = new THREE.Mesh(geo, mat);

    // edge glow
    const edgeMat = new THREE.LineBasicMaterial({color:def.color,transparent:true,opacity:0.6});
    mesh.add(new THREE.LineSegments(new THREE.EdgesGeometry(geo),edgeMat));

    // special: golden apple glow light
    if(defKey==='golden_apple'){
        const pl=new THREE.PointLight(0xffdd00,1.5,6);
        mesh.add(pl);
    }
    return mesh;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPAWN ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnAllItems() {
    SPAWN_TABLE.forEach(s=>{
        if(!pickedUpItems[s.id]) spawnItemMesh(s.id, s.def, s.x, s.z);
    });
}

function spawnItemMesh(id, defKey, x, z) {
    if(worldItemMeshes[id]) return;
    const mesh = makeItemMesh(defKey);
    mesh.position.set(x, 0.4, z);
    mesh.userData = {id, defKey, x, z};
    scene.add(mesh);
    worldItemMeshes[id] = mesh;
}

function removeWorldItem(id) {
    if(worldItemMeshes[id]){ scene.remove(worldItemMeshes[id]); delete worldItemMeshes[id]; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setupInput() {
    document.addEventListener('keydown',e=>{
        if(chatting) return;
        keys[e.key.toLowerCase()]=true;
        if(e.key==='/')       { e.preventDefault(); openChat(); }
        if(e.key.toLowerCase()==='e') tryPickup();
        if(e.key.toLowerCase()==='q') tryDrop();
        if(e.key.toLowerCase()==='f') handleF();
        if(e.key==='Escape')  document.exitPointerLock();
        const n=parseInt(e.key);
        if(n>=1&&n<=5) selectSlot(n-1);
    });
    document.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()]=false; });

    const canvas=document.getElementById('game-canvas');
    canvas.addEventListener('click',()=>{ if(!chatting) canvas.requestPointerLock(); });
    document.addEventListener('mousemove',e=>{
        if(document.pointerLockElement!==canvas||chatting) return;
        prevYaw=yaw;
        yaw   -= e.movementX*0.002;
        pitch -= e.movementY*0.002;
        pitch  = Math.max(-Math.PI/3,Math.min(Math.PI/4,pitch));

        // FLAIL: detect fast flick
        if(pvpMode) checkFlailSwing(Math.abs(e.movementX));
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  F KEY  â€” attack if holding weapon, else toggle 3rd person
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleF() {
    const item = inventory[selectedSlot];
    if(!item) { toggleThirdPerson(); return; }
    const def = ITEM_DEFS[item.defKey];
    if(!def || def.type!=='weapon') { toggleThirdPerson(); return; }
    if(def.special==='flail') { showNotif("Flail: flick your mouse to swing!"); return; }
    tryAttack();
}

function toggleThirdPerson() {
    thirdPerson = !thirdPerson;
    selfMesh.visible = thirdPerson;
    showNotif(thirdPerson ? '3rd person ON' : '1st person ON');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openChat() {
    chatting=true; document.exitPointerLock();
    const wrap=document.getElementById('chat-input-wrap');
    const inp=document.getElementById('chat-in');
    wrap.style.display='block'; inp.value='';
    setTimeout(()=>inp.focus(),50);
    inp.onkeydown=e=>{
        if(e.key==='Enter'){ const t=inp.value.trim(); if(t) db.ref("claregame_chat").push({username:currentUser,text:t,time:Date.now()}); closeChat(); }
        if(e.key==='Escape') closeChat();
    };
}
function closeChat() {
    chatting=false;
    document.getElementById('chat-input-wrap').style.display='none';
    document.getElementById('chat-in').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVENTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectSlot(i) {
    selectedSlot=i;
    updateInventoryUI();
    applyPassiveEffects();
}

function updateInventoryUI() {
    for(let i=0;i<5;i++){
        const s=document.getElementById('slot-'+i);
        const item=inventory[i];
        s.innerHTML=item?item.emoji:'';
        s.innerHTML+=`<span class="slot-label">${i+1}</span>`;
        s.title=item?item.name:'';
        s.classList.toggle('active',i===selectedSlot);
        if(item?.defKey==='golden_apple') s.classList.add('golden'); else s.classList.remove('golden');
    }
}

// passive effects from held items
function applyPassiveEffects() {
    let spd=1;
    inventory.forEach(item=>{
        if(!item) return;
        const def=ITEM_DEFS[item.defKey];
        if(def.special==='speed') spd=Math.max(spd,1.25);     // balloon
        if(def.speed && def.speed>1) spd=Math.max(spd,def.speed); // katana
    });
    speedMult=spd;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PICKUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryPickup() {
    const px=camera.position.x, pz=camera.position.z;
    for(const spawn of SPAWN_TABLE){
        if(pickedUpItems[spawn.id]) continue;
        const m=worldItemMeshes[spawn.id];
        if(!m) continue;
        const dx=m.position.x-px, dz=m.position.z-pz;
        if(Math.sqrt(dx*dx+dz*dz)<PICKUP_DIST){
            const slot=inventory.indexOf(null);
            if(slot===-1){ showNotif("Inventory full!"); return; }

            const def=ITEM_DEFS[spawn.def];

            // Consumable items â€” use immediately
            if(def.type==='item' && ['heal','speed_burst','poison','golden'].includes(def.special)){
                useConsumable(spawn, def);
                db.ref("claregame_items/"+spawn.id).set({pickedBy:currentUser,time:Date.now()});
                removeWorldItem(spawn.id);
                pickedUpItems[spawn.id]=true;
                sysChat(`${currentUser} picked up ${def.emoji} ${spawn.def}`);
                return;
            }

            // Traps â€” place immediately where you picked them up? No â€” add to inv
            inventory[slot]={id:spawn.id, defKey:spawn.def, emoji:def.emoji, name:spawn.def};
            updateInventoryUI();
            applyPassiveEffects();
            db.ref("claregame_items/"+spawn.id).set({pickedBy:currentUser,time:Date.now()});
            removeWorldItem(spawn.id);
            pickedUpItems[spawn.id]=true;
            showNotif(`Picked up ${def.emoji} ${spawn.def}`);
            sysChat(`${currentUser} picked up ${def.emoji} ${spawn.def}`);
            return;
        }
    }
    // Also check dynamic dropped items
    for(const [id, mesh] of Object.entries(worldItemMeshes)){
        if(SPAWN_TABLE.find(s=>s.id===id)) continue; // already handled
        const dx=mesh.position.x-px, dz=mesh.position.z-pz;
        if(Math.sqrt(dx*dx+dz*dz)<PICKUP_DIST){
            const slot=inventory.indexOf(null);
            if(slot===-1){ showNotif("Inventory full!"); return; }
            const {defKey}=mesh.userData;
            const def=ITEM_DEFS[defKey];
            inventory[slot]={id, defKey, emoji:def.emoji, name:defKey};
            updateInventoryUI(); applyPassiveEffects();
            removeWorldItem(id); pickedUpItems[id]=true;
            db.ref("claregame_items/"+id).set({pickedBy:currentUser,time:Date.now()});
            showNotif(`Picked up ${def.emoji} ${defKey}`);
            return;
        }
    }
}

function useConsumable(spawn, def) {
    if(def.special==='heal'){
        myHP=Math.min(MAX_HP, myHP+def.value);
        updateHealthUI();
        showNotif(`${def.emoji} Healed +${def.value}hp!`);
    } else if(def.special==='speed_burst'){
        addStatus('âš¡ Speed',def.value*1000);
        speedMult=1.8;
        showNotif('âš¡ Speed boost!');
        setTimeout(()=>{ speedMult=1; applyPassiveEffects(); removeStatus('âš¡ Speed'); },def.value*1000);
    } else if(def.special==='poison'){
        // poison self (it's a trick!)
        dealDamageToSelf(def.value,'Poison Apple','poison_apple',null);
        showNotif('ğŸ’€ It was poisoned!');
    } else if(def.special==='golden'){
        myHP=MAX_HP; updateHealthUI();
        goldenImmune=true;
        addStatus('âœ¨ Immune',5000);
        showNotif('âœ¨ GOLDEN APPLE! Full heal + 5s immunity!');
        sysChat(`âœ¨ ${currentUser} used the Golden Apple!`);
        setTimeout(()=>{ goldenImmune=false; removeStatus('âœ¨ Immune'); },5000);
        // remove golden apple from world for everyone
        db.ref("claregame_items/g1").set({pickedBy:currentUser,time:Date.now()});
        // respawn after 60 seconds
        setTimeout(()=>{
            db.ref("claregame_items/g1").remove();
            if(pickedUpItems['g1']){ delete pickedUpItems['g1']; spawnItemMesh('g1','golden_apple',0,0); }
            sysChat('âœ¨ The Golden Apple has respawned!');
        },60000);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DROP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryDrop() {
    const item=inventory[selectedSlot];
    if(!item){ showNotif("Nothing to drop!"); return; }

    // Count floor weapons/items
    const floorCount=Object.keys(worldItemMeshes).length;
    const def=ITEM_DEFS[item.defKey];
    const isWeapon=def.type==='weapon';
    let wCount=0,iCount=0;
    Object.values(worldItemMeshes).forEach(m=>{
        const d=ITEM_DEFS[m.userData.defKey];
        if(d&&d.type==='weapon') wCount++; else iCount++;
    });
    if(isWeapon&&wCount>=MAX_FLOOR_WEAPONS){ showNotif("Too many weapons on ground! Disappeared."); inventory[selectedSlot]=null; updateInventoryUI(); applyPassiveEffects(); delete pickedUpItems[item.id]; db.ref("claregame_items/"+item.id).remove(); return; }
    if(!isWeapon&&iCount>=MAX_FLOOR_ITEMS){ showNotif("Too many items on ground! Disappeared."); inventory[selectedSlot]=null; updateInventoryUI(); applyPassiveEffects(); delete pickedUpItems[item.id]; db.ref("claregame_items/"+item.id).remove(); return; }

    const dropX=+(camera.position.x+Math.sin(yaw)*1.5).toFixed(2);
    const dropZ=+(camera.position.z+Math.cos(yaw)*1.5).toFixed(2);

    db.ref("claregame_items/"+item.id).remove();
    const mesh=makeItemMesh(item.defKey);
    mesh.position.set(dropX,0.4,dropZ);
    mesh.userData={id:item.id,defKey:item.defKey,x:dropX,z:dropZ};
    scene.add(mesh); worldItemMeshes[item.id]=mesh;
    inventory[selectedSlot]=null;
    delete pickedUpItems[item.id];
    updateInventoryUI(); applyPassiveEffects();
    showNotif(`Dropped ${item.emoji} ${item.defKey}`);
    db.ref("claregame_drop").push({id:item.id,defKey:item.defKey,x:dropX,z:dropZ,by:currentUser,time:Date.now()});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ATTACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryAttack() {
    if(!pvpMode){ showNotif('PVP is OFF'); return; }
    const now=Date.now();
    const item=inventory[selectedSlot];
    if(!item){ showNotif('Equip a weapon!'); return; }
    const def=ITEM_DEFS[item.defKey];
    if(!def||def.type!=='weapon'){ showNotif('That is not a weapon!'); return; }
    if(def.special==='flail'){ showNotif('Flail: flick mouse to swing!'); return; }
    if(now-lastAttackTime<def.cooldown){
        showNotif(`â± ${((def.cooldown-(now-lastAttackTime))/1000).toFixed(1)}s cooldown`);
        return;
    }
    lastAttackTime=now;

    if(def.special==='projectile'){
        fireProjectile(def, item.defKey);
        return;
    }

    // Melee
    const px=camera.position.x, pz=camera.position.z;
    let hit=false;
    Object.entries(otherPlayers).forEach(([u,op])=>{
        const dx=op.mesh.position.x-px, dz=op.mesh.position.z-pz;
        if(Math.sqrt(dx*dx+dz*dz)<def.range){
            sendHit(u, def.damage, item.defKey);
            if(def.special==='bleed') sendBleed(u, 10, 5, item.defKey);
            hit=true;
            flashMesh(op.mesh,0xffff00);
        }
    });
    if(!hit) showNotif('No one in range!');
    else playAttackAnim(def.special);
}

function sendHit(target, dmg, weapon) {
    db.ref("claregame_hits/"+target).set({from:currentUser,weapon,dmg,time:Date.now()});
    showNotif(`âš”ï¸ Hit ${target}! (-${dmg}hp)`);
}

function sendBleed(target, totalDmg, seconds, weapon) {
    db.ref("claregame_bleed/"+target).set({from:currentUser,weapon,dmgPerSec:totalDmg/seconds,seconds,time:Date.now()});
}

function fireProjectile(def, defKey) {
    const geo=new THREE.SphereGeometry(0.08,6,6);
    const mat=new THREE.MeshBasicMaterial({color:defKey==='bow'?0xffaa00:0x00aaff});
    const mesh=new THREE.Mesh(geo,mat);
    mesh.position.copy(camera.position);
    mesh.position.y=PLAYER_HEIGHT*0.8;

    const dir=new THREE.Vector3(0,0,-1).applyEuler(new THREE.Euler(pitch,yaw,0,'YXZ'));
    scene.add(mesh);
    projectiles.push({mesh,vel:dir.multiplyScalar(def.projSpeed),owner:currentUser,dmg:def.damage,weapon:defKey,born:Date.now(),hit:false});
    showNotif(`${ITEM_DEFS[defKey].emoji} Fired!`);
}

// Flail â€” triggered by fast mouse flick
let flailLastCheck=0;
function checkFlailSwing(movementX) {
    const item=inventory[selectedSlot];
    if(!item||item.defKey!=='flail') return;
    if(!pvpMode) return;
    const now=Date.now();
    if(now-flailLastCheck<500) return; // don't spam
    if(movementX>20){ // threshold for "flick"
        flailLastCheck=now;
        const px=camera.position.x, pz=camera.position.z;
        Object.entries(otherPlayers).forEach(([u,op])=>{
            const dx=op.mesh.position.x-px, dz=op.mesh.position.z-pz;
            if(Math.sqrt(dx*dx+dz*dz)<4.0){
                sendHit(u,40,'flail');
                flashMesh(op.mesh,0xff8800);
            }
        });
    }
}

function playAttackAnim(type) {
    // Visual flash on crosshair
    const ch=document.getElementById('crosshair');
    ch.style.transform='translate(-50%,-50%) scale(1.8)';
    ch.style.opacity='0.4';
    setTimeout(()=>{ ch.style.transform='translate(-50%,-50%) scale(1)'; ch.style.opacity='1'; },200);
}

function flashMesh(mesh, color) {
    mesh.traverse(c=>{ if(c.isMesh&&c.material&&c.material.color){ c.material._orig=c.material.color.getHex(); c.material.color.set(color); } });
    setTimeout(()=>{ mesh.traverse(c=>{ if(c.isMesh&&c.material&&c.material.color&&c.material._orig!==undefined) c.material.color.set(c.material._orig); }); },160);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PVP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPVP() {
    // Listen for hits on self
    db.ref("claregame_hits/"+currentUser).on("value",snap=>{
        if(!snap.exists()) return;
        const hit=snap.val();
        if(Date.now()-hit.time>3000) return;
        if(!pvpMode||goldenImmune) return;
        dealDamageToSelf(hit.dmg, hit.weapon, hit.weapon, hit.from);
        db.ref("claregame_hits/"+currentUser).remove();
    });
    // Listen for bleed on self
    db.ref("claregame_bleed/"+currentUser).on("value",snap=>{
        if(!snap.exists()) return;
        const b=snap.val();
        if(Date.now()-b.time>3000) return;
        if(!pvpMode||goldenImmune) return;
        applyBleed(b.dmgPerSec, b.seconds, b.from);
        db.ref("claregame_bleed/"+currentUser).remove();
    });
    // PVP toggle
    db.ref("claregame_pvp").on("value",snap=>{
        pvpMode=snap.val()===true;
        updatePVPUI();
    });
    // Other players' HP for overhead bars
    db.ref("claregame_hp").on("value",snap=>{
        snap.forEach(c=>{
            const u=c.key; if(u===currentUser) return;
            if(otherPlayers[u]) otherPlayers[u].hp=c.val();
        });
    });
    // Listen for drops
    db.ref("claregame_drop").limitToLast(50).on("value",snap=>{
        snap.forEach(c=>{
            const d=c.val();
            if(d.by===currentUser) return; // already handled locally
            if(!worldItemMeshes[d.id]&&!pickedUpItems[d.id]){
                const mesh=makeItemMesh(d.defKey);
                mesh.position.set(d.x,0.4,d.z);
                mesh.userData={id:d.id,defKey:d.defKey,x:d.x,z:d.z};
                scene.add(mesh); worldItemMeshes[d.id]=mesh;
            }
        });
    });
}

function dealDamageToSelf(dmg, weaponName, defKey, from) {
    myHP=Math.max(0,myHP-dmg);
    updateHealthUI();
    const fromStr=from?` from ${from}`:'';
    showNotif(`ğŸ’¥ Hit by ${weaponName}${fromStr} (-${dmg}hp)`);
    const flash=document.createElement('div');
    flash.style.cssText='position:fixed;inset:0;background:rgba(235,77,75,0.3);pointer-events:none;z-index:9000;';
    document.body.appendChild(flash);
    setTimeout(()=>flash.remove(),200);
    // publish HP
    db.ref("claregame_hp/"+currentUser).set(myHP);
    if(myHP<=0) handleDeath(from||'unknown');
}

function applyBleed(dmgPerSec, seconds, from) {
    addStatus('ğŸ©¸ Bleed',seconds*1000);
    let elapsed=0;
    const iv=setInterval(()=>{
        if(elapsed>=seconds||myHP<=0){ clearInterval(iv); removeStatus('ğŸ©¸ Bleed'); return; }
        dealDamageToSelf(dmgPerSec,'Bleed','spear',from);
        elapsed++;
    },1000);
}

function togglePVP() {
    db.ref("claregame_pvp").set(!pvpMode);
}

function updatePVPUI() {
    const btn=document.getElementById('pvp-btn');
    const ind=document.getElementById('pvp-indicator');
    if(pvpMode){
        btn.style.background='#eb4d4b'; btn.innerText='âš”ï¸ PVP: ON';
        ind.style.display='block';
    } else {
        btn.style.background='#2f3542'; btn.innerText='âš”ï¸ PVP: OFF';
        ind.style.display='none';
    }
}

function updateHealthUI() {
    document.getElementById('hp-val').innerText=myHP;
    const pct=myHP/MAX_HP*100;
    const fill=document.getElementById('hp-fill');
    fill.style.width=pct+'%';
    fill.style.background=pct>60?'var(--primary)':pct>30?'#f39c12':'#eb4d4b';
}

function addStatus(label,ms) {
    const el=document.createElement('div');
    el.className='status-tag'; el.innerText=label; el.id='st_'+label.replace(/\s/g,'_');
    document.getElementById('status-effects').appendChild(el);
    setTimeout(()=>el.remove(),ms);
}
function removeStatus(label) {
    const el=document.getElementById('st_'+label.replace(/\s/g,'_'));
    if(el) el.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleDeath(killedBy) {
    myHP=MAX_HP; updateHealthUI(); goldenImmune=false;
    // Respawn at random spot
    camera.position.set((Math.random()-0.5)*30, PLAYER_HEIGHT, (Math.random()-0.5)*30);

    // Drop all inventory scattered AROUND death position, not on same spot
    inventory.forEach((item,i)=>{
        if(!item) return;
        const angle=Math.random()*Math.PI*2;
        const dist=1.5+Math.random()*2;
        const dx=camera.position.x+Math.cos(angle)*dist;
        const dz=camera.position.z+Math.sin(angle)*dist;
        inventory[i]=null;
        const mesh=makeItemMesh(item.defKey);
        mesh.position.set(dx,0.4,dz);
        mesh.userData={id:item.id,defKey:item.defKey,x:dx,z:dz};
        scene.add(mesh); worldItemMeshes[item.id]=mesh;
        delete pickedUpItems[item.id];
        db.ref("claregame_items/"+item.id).remove();
        db.ref("claregame_drop").push({id:item.id,defKey:item.defKey,x:dx,z:dz,by:currentUser,time:Date.now()});
    });

    updateInventoryUI(); applyPassiveEffects();
    sysChat(`ğŸ’€ ${currentUser} was slain by ${killedBy}!`);
    showNotif(`ğŸ’€ Killed by ${killedBy}! Respawned.`);
    db.ref("claregame_hp/"+currentUser).set(MAX_HP);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESET ITEMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetAllItems() {
    if(currentUser!=='bartelsfamily5') return;
    if(!confirm('Reset ALL items?')) return;
    db.ref("claregame_items").remove();
    db.ref("claregame_drop").remove();
    Object.values(worldItemMeshes).forEach(m=>scene.remove(m));
    worldItemMeshes={}; pickedUpItems={};
    inventory=[null,null,null,null,null]; updateInventoryUI(); applyPassiveEffects();
    spawnAllItems();
    sysChat('ğŸ”„ bartelsfamily5 reset all items!');
    showNotif('All items reset!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO SPAWN NEW WEAPON EVERY MINUTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startAutoSpawn() {
    setInterval(()=>{
        const wCount=Object.values(worldItemMeshes).filter(m=>ITEM_DEFS[m.userData.defKey]?.type==='weapon').length;
        if(wCount>=MAX_FLOOR_WEAPONS) return;
        const weapons=Object.keys(ITEM_DEFS).filter(k=>ITEM_DEFS[k].type==='weapon');
        const pick=weapons[Math.floor(Math.random()*weapons.length)];
        const x=(Math.random()-0.5)*60, z=(Math.random()-0.5)*60;
        const id='auto_'+Date.now();
        const mesh=makeItemMesh(pick);
        mesh.position.set(x,0.4,z);
        mesh.userData={id,defKey:pick,x,z};
        scene.add(mesh); worldItemMeshes[id]=mesh;
        sysChat(`âš”ï¸ A ${ITEM_DEFS[pick].emoji} ${pick} appeared!`);
    },60000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initFirebase() {
    // Chat
    db.ref("claregame_chat").limitToLast(25).on("value",snap=>{
        const panel=document.getElementById('chat-log'); panel.innerHTML='';
        snap.forEach(c=>{
            const d=c.val(); const div=document.createElement('div'); div.className='chat-line';
            const isSys=d.username==='SYSTEM';
            div.innerHTML=`<span class="cname ${isSys?'sys':''}">${d.username}</span>${d.text}`;
            panel.appendChild(div);
        });
        panel.scrollTop=panel.scrollHeight;
        snap.forEach(c=>{
            const d=c.val();
            if(d.username!=='SYSTEM'&&Date.now()-d.time<5000) showBubble(d.username,d.text);
        });
    });

    // Other players
    db.ref("claregame_players").on("value",snap=>{
        const alive={};
        snap.forEach(c=>{
            const u=c.key; if(u===currentUser) return;
            alive[u]=true; const d=c.val();
            if(!otherPlayers[u]){
                const hue=Math.abs(hashCode(u))%360;
                const color=new THREE.Color(`hsl(${hue},70%,55%)`);
                const mesh=makePlayerMesh(color.getHex());
                scene.add(mesh);
                // Overhead HP bar
                const hpEl=document.createElement('div'); hpEl.className='overhead-hp';
                const hpBar=document.createElement('div'); hpBar.className='overhead-hp-bar';
                const hpFill=document.createElement('div'); hpFill.className='overhead-hp-fill'; hpFill.style.width='100%';
                hpBar.appendChild(hpFill); hpEl.appendChild(hpBar); document.body.appendChild(hpEl);
                otherPlayers[u]={mesh,nameEl:null,hpEl,hpFill,hp:MAX_HP,color:color.getHex()};
            }
            otherPlayers[u].mesh.position.set(d.x,0,d.z);
            otherPlayers[u].mesh.rotation.y=d.yaw||0;
        });
        Object.keys(otherPlayers).forEach(u=>{
            if(!alive[u]){
                scene.remove(otherPlayers[u].mesh);
                if(otherPlayers[u].nameEl) otherPlayers[u].nameEl.remove();
                if(otherPlayers[u].hpEl)   otherPlayers[u].hpEl.remove();
                delete otherPlayers[u];
            }
        });
    });

    // Items picked up by others
    db.ref("claregame_items").on("value",snap=>{
        snap.forEach(c=>{
            const id=c.key;
            if(!pickedUpItems[id]){ pickedUpItems[id]=true; removeWorldItem(id); }
        });
    });

    // Broadcast position + HP
    setInterval(()=>{
        if(!currentUser||!camera) return;
        db.ref("claregame_players/"+currentUser).set({
            x:+camera.position.x.toFixed(2), z:+camera.position.z.toFixed(2),
            yaw:+yaw.toFixed(3), t:Date.now()
        });
        db.ref("claregame_hp/"+currentUser).set(myHP);
    },100);

    db.ref("claregame_players/"+currentUser).onDisconnect().remove();
    db.ref("claregame_hp/"+currentUser).onDisconnect().remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPEECH BUBBLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showBubble(username, text) {
    if(bubbles[username]){ clearTimeout(bubbles[username].timer); bubbles[username].el.innerText=text; }
    else {
        const el=document.createElement('div'); el.className='overhead-bubble'; el.innerText=text;
        document.body.appendChild(el); bubbles[username]={el};
    }
    bubbles[username].timer=setTimeout(()=>{ if(bubbles[username]){bubbles[username].el.remove();delete bubbles[username];} },5000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function animate() {
    requestAnimationFrame(animate);
    const dt=clock.getDelta();
    if(!chatting) movePlayer(dt);

    // Projectiles
    for(let i=projectiles.length-1;i>=0;i--){
        const p=projectiles[i];
        p.mesh.position.addScaledVector(p.vel,dt);
        p.mesh.position.y=Math.max(0.5, p.mesh.position.y-dt*0.5); // slight drop

        // Check hit on other players
        if(pvpMode){
            Object.entries(otherPlayers).forEach(([u,op])=>{
                if(p.hit) return;
                const dx=op.mesh.position.x-p.mesh.position.x;
                const dz=op.mesh.position.z-p.mesh.position.z;
                if(Math.sqrt(dx*dx+dz*dz)<1.0){
                    sendHit(u,p.dmg,p.weapon);
                    flashMesh(op.mesh,0xffff00);
                    p.hit=true;
                    // Arrow stays in player until death/60s
                    op.mesh.add(p.mesh);
                    p.mesh.position.set(0,1.3,0);
                    setTimeout(()=>{ if(p.mesh.parent) p.mesh.parent.remove(p.mesh); scene.remove(p.mesh); },60000);
                    projectiles.splice(i,1);
                }
            });
        }
        // Expire after 5 seconds if no hit
        if(!p.hit && Date.now()-p.born>5000){ scene.remove(p.mesh); projectiles.splice(i,1); }
    }

    // Traps
    checkTraps();

    // Item bob + spin
    const t=Date.now()*0.001;
    Object.values(worldItemMeshes).forEach(m=>{
        m.position.y=0.35+Math.sin(t*2+m.position.x)*0.13;
        m.rotation.y+=dt*1.4;
    });

    // Flail wobble visual (show chain + ball swinging)
    flailAngle+=dt*3;

    // Pickup prompt
    const near=getNearItem();
    const pp=document.getElementById('pickup-prompt');
    pp.style.display=near?'block':'none';
    if(near){ const def=ITEM_DEFS[near.defKey]; pp.innerText=`[ E ] pick up ${def.emoji} ${near.defKey}`; }

    // 3rd person: position self mesh
    if(thirdPerson && selfMesh){
        selfMesh.position.set(camera.position.x, 0, camera.position.z);
        selfMesh.rotation.y=yaw;
    }

    updateOverheads();
    renderer.render(scene,camera);
}

function checkTraps() {
    // Check floor items that are traps and haven't been placed
    const px=camera.position.x, pz=camera.position.z;
    // Placed trap check (from Firebase would be ideal but for now local)
    Object.entries(worldItemMeshes).forEach(([id,mesh])=>{
        const def=ITEM_DEFS[mesh.userData.defKey];
        if(!def) return;
        if(def.special!=='trap'&&def.special!=='web') return;
        const owner=mesh.userData.placedBy;
        if(owner===currentUser) return; // don't trap yourself
        const dx=mesh.position.x-px, dz=mesh.position.z-pz;
        if(Math.sqrt(dx*dx+dz*dz)<(def.trapRadius||1.5)){
            if(!mesh.userData.triggered){
                mesh.userData.triggered=true;
                if(def.special==='trap'){
                    dealDamageToSelf(def.value,'Bear Trap','bear_trap',owner||'trap');
                    addStatus('ğŸ¢ Slowed',def.trapTime);
                    speedMult=Math.min(speedMult,def.trapSlow);
                    setTimeout(()=>{ speedMult=1; applyPassiveEffects(); removeStatus('ğŸ¢ Slowed'); },def.trapTime);
                    removeWorldItem(id); delete pickedUpItems[id];
                    showNotif('ğŸª¤ Bear Trap! Slowed + damaged!');
                } else { // web
                    addStatus('ğŸ•¸ï¸ Webbed',3000);
                    speedMult=Math.min(speedMult,def.trapSlow);
                    setTimeout(()=>{ speedMult=1; applyPassiveEffects(); removeStatus('ğŸ•¸ï¸ Webbed'); mesh.userData.triggered=false; },3000);
                    showNotif('ğŸ•¸ï¸ Caught in a web!');
                }
            }
        }
    });
}

function movePlayer(dt) {
    const dir=new THREE.Vector3();
    if(keys['w']||keys['arrowup'])    dir.z-=1;
    if(keys['s']||keys['arrowdown'])  dir.z+=1;
    if(keys['a']||keys['arrowleft'])  dir.x-=1;
    if(keys['d']||keys['arrowright']) dir.x+=1;
    if(dir.lengthSq()>0){
        dir.normalize().applyEuler(new THREE.Euler(0,yaw,0));
        const spd=PLAYER_SPEED*speedMult;
        camera.position.x=Math.max(-48,Math.min(48,camera.position.x+dir.x*spd*dt));
        camera.position.z=Math.max(-48,Math.min(48,camera.position.z+dir.z*spd*dt));
    }
    camera.position.y=thirdPerson?PLAYER_HEIGHT+2.5:PLAYER_HEIGHT;
    camera.rotation.y=yaw; camera.rotation.x=thirdPerson?-0.3:pitch;
}

function getNearItem() {
    const px=camera.position.x, pz=camera.position.z;
    for(const [id,mesh] of Object.entries(worldItemMeshes)){
        if(pickedUpItems[id]) continue;
        const dx=mesh.position.x-px, dz=mesh.position.z-pz;
        if(Math.sqrt(dx*dx+dz*dz)<PICKUP_DIST) return {id, defKey:mesh.userData.defKey};
    }
    return null;
}

function updateOverheads() {
    Object.entries(otherPlayers).forEach(([u,op])=>{
        _v3.set(op.mesh.position.x,op.mesh.position.y+2.1,op.mesh.position.z);
        const sc=toScreen(_v3);
        if(!op.nameEl){
            const el=document.createElement('div'); el.className='overhead-name'; el.innerText=u;
            document.body.appendChild(el); op.nameEl=el;
        }
        if(sc){
            op.nameEl.style.display='block'; op.nameEl.style.left=sc.x+'px'; op.nameEl.style.top=sc.y+'px';
            op.hpEl.style.display='block'; op.hpEl.style.left=sc.x+'px'; op.hpEl.style.top=(sc.y+18)+'px';
            const pct=(op.hp||MAX_HP)/MAX_HP*100;
            op.hpFill.style.width=pct+'%';
            op.hpFill.style.background=pct>60?'#2ed573':pct>30?'#f39c12':'#eb4d4b';
        } else {
            op.nameEl.style.display='none'; op.hpEl.style.display='none';
        }
        if(bubbles[u]){
            _v3.set(op.mesh.position.x,op.mesh.position.y+2.9,op.mesh.position.z);
            const bs=toScreen(_v3);
            if(bs){ bubbles[u].el.style.display='block'; bubbles[u].el.style.left=bs.x+'px'; bubbles[u].el.style.top=bs.y+'px'; }
            else bubbles[u].el.style.display='none';
        }
    });
}

function toScreen(pos) {
    const v=pos.clone().project(camera);
    if(v.z>1) return null;
    return { x:(v.x*0.5+0.5)*window.innerWidth, y:(-v.y*0.5+0.5)*window.innerHeight };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showNotif(msg) {
    const el=document.getElementById('notif');
    el.innerText=msg; el.style.display='block';
    clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',2500);
}
function sysChat(msg) {
    db.ref("claregame_chat").push({username:'SYSTEM',text:msg,time:Date.now()});
}
function hashCode(s) {
    let h=0; for(let i=0;i<s.length;i++) h=s.charCodeAt(i)+((h<<5)-h); return h;
}
window.addEventListener('beforeunload',()=>{
    if(currentUser){ db.ref("claregame_players/"+currentUser).remove(); db.ref("claregame_hp/"+currentUser).remove(); }
});
</script>
</body>
</html>
